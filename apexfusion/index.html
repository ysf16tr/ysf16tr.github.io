<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apex Fusion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
                apiKey: "AIzaSyBypJftfCA6AdJmSUEiMrl17s9md16C_RA",
                authDomain: "apex-fusion-v1.firebaseapp.com",
                projectId: "apex-fusion-v1",
                storageBucket: "apex-fusion-v1.firebasestorage.app",
                messagingSenderId: "568547733591",
                appId: "1:568547733591:web:5b3d3637ec99dfc9007312"
            };

        firebase.initializeApp(firebaseConfig);

        const auth = firebase.auth();
        const db = firebase.firestore();

        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'rpg-bg': '#1a1a1a',
                        'rpg-card': '#2c2c2c',
                        'rpg-accent': '#ff4500',
                        'rpg-accent-hover': '#e03e00',
                        'rpg-text': '#f0f0f0',
                        'rpg-subtext': '#a0a0a0',
                        'rpg-border': '#444444',
                        'rpg-progress-bg': '#444444',
                        'rpg-physical': 'rgba(255, 69, 0, 0.7)',
                        'rpg-mental': 'rgba(0, 206, 209, 0.7)',
                        'rpg-streak': '#ffd700',
                        'rpg-modal-bg': 'rgba(0, 0, 0, 0.7)',
                    },
                    fontFamily: {
                      sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        body {
            @apply bg-rpg-bg text-rpg-text font-sans;
        }
        .task-checkbox:checked + label {
            @apply line-through text-rpg-subtext;
        }
        .stat-bar-container {
            @apply mb-4;
        }
        #chartContainer {
             @apply relative h-64 md:h-96;
        }
        .modal {
            @apply fixed inset-0 bg-rpg-modal-bg flex items-center justify-center p-4 z-50 transition-opacity duration-300 ease-in-out;
        }
        .modal-content {
            @apply bg-rpg-card rounded-lg shadow-xl p-6 max-w-sm w-full border border-rpg-border;
        }
        .tooltip {
            @apply relative cursor-pointer;
        }
        .tooltip:hover::after {
            content: attr(data-tooltip);
            @apply absolute bg-gray-900 text-white text-xs rounded py-1 px-2 -top-8 left-1/2 transform -translate-x-1/2 whitespace-nowrap z-10;
        }
        .form-input, .form-select {
             @apply w-full px-3 py-2 bg-gray-700 border border-rpg-border rounded-md text-rpg-text focus:outline-none focus:ring-1 focus:ring-rpg-accent focus:border-rpg-accent text-sm;
        }
        .form-label {
            @apply block text-sm font-medium text-rpg-subtext mb-1;
        }
        .btn {
            @apply py-2 px-4 rounded-lg font-semibold transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-opacity-50 shadow;
        }
        .btn-primary {
            @apply bg-rpg-accent text-white hover:bg-rpg-accent-hover focus:ring-rpg-accent;
        }
         .btn-secondary {
            @apply bg-gray-600 text-rpg-text hover:bg-gray-500 focus:ring-gray-400;
        }
        .btn-danger {
            @apply bg-red-600 text-white hover:bg-red-700 focus:ring-red-500;
        }
         .btn-google {
            @apply bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500;
        }
    </style>
</head>
<body class="antialiased">

    <header class="bg-rpg-card py-4 px-6 text-center shadow-lg">
        <h1 class="text-3xl font-bold text-rpg-accent tracking-wider">Apex Fusion</h1>
         <div id="auth-status" class="mt-2 text-sm text-rpg-subtext">
             <span id="user-email">Misafir</span>
             <button id="auth-button" class="btn btn-secondary btn-sm ml-2">GiriÅŸ Yap</button>
         </div>
    </header>

    <main class="container mx-auto p-4 md:p-6 lg:p-8 max-w-6xl">

        <section class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <article class="bg-rpg-card rounded-xl p-5 shadow-md border border-rpg-border">
                <h3 class="text-xl font-semibold mb-4 text-rpg-accent border-b border-rpg-border pb-2">Fiziksel Rutin</h3>
                <div id="physicalTasks" class="space-y-3">
                    <p class="text-rpg-subtext text-sm italic">YÃ¼kleniyor...</p>
                </div>
            </article>
            <article class="bg-rpg-card rounded-xl p-5 shadow-md border border-rpg-border">
                <h3 class="text-xl font-semibold mb-4 text-rpg-accent border-b border-rpg-border pb-2">Zihinsel Rutin</h3>
                 <div id="mentalTasks" class="space-y-3">
                     <p class="text-rpg-subtext text-sm italic">YÃ¼kleniyor...</p>
                 </div>
            </article>
        </section>

        <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
            <div class="bg-rpg-card rounded-xl p-5 shadow-md text-center border border-rpg-border">
                <h3 class="text-lg font-semibold mb-2 text-rpg-subtext">GÃ¶rev TamamlandÄ±</h3>
                <p id="doneCount" class="text-3xl font-bold text-rpg-accent">0 / 0</p>
            </div>
            <div class="bg-rpg-card rounded-xl p-5 shadow-md text-center border border-rpg-border">
                <h3 class="text-lg font-semibold mb-2 text-rpg-subtext">Seviye</h3>
                <p id="level" class="text-3xl font-bold text-rpg-accent">1</p>
            </div>
             <div class="bg-rpg-card rounded-xl p-5 shadow-md text-center border border-rpg-border">
                <h3 class="text-lg font-semibold mb-2 text-rpg-subtext">Toplam XP</h3>
                <p id="xpCount" class="text-3xl font-bold text-rpg-accent">0</p>
                 <div class="w-full bg-rpg-progress-bg rounded-full h-2.5 mt-2">
                    <div id="xpBar" class="bg-rpg-accent h-2.5 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                </div>
                <p id="xpNextLevel" class="text-xs text-rpg-subtext mt-1">Sonraki seviye iÃ§in: 100 XP</p>
            </div>
             <div class="bg-rpg-card rounded-xl p-5 shadow-md text-center border border-rpg-border">
                <h3 class="text-lg font-semibold mb-2 text-rpg-subtext">GÃ¼nlÃ¼k Seri</h3>
                 <p id="streakCount" class="text-3xl font-bold text-rpg-streak">
                    <i class="fas fa-fire"></i> 0
                </p>
                 <p class="text-xs text-rpg-subtext mt-1">GÃ¼n</p>
            </div>
            <div class="bg-rpg-card rounded-xl p-5 shadow-md text-center border border-rpg-border">
                <h3 class="text-lg font-semibold mb-2 text-rpg-subtext">Rozetler</h3>
                <div class="flex justify-center items-center space-x-2 min-h-[40px]" id="badges">
                    <span class="text-rpg-subtext text-sm">HenÃ¼z rozet yok</span>
                </div>
            </div>
        </section>

        <section class="bg-rpg-card rounded-xl p-5 shadow-md mb-8 border border-rpg-border">
            <h3 class="text-xl font-semibold mb-4 text-rpg-accent border-b border-rpg-border pb-2">Yetenekler (Bu Ay)</h3>
             <div id="statBars" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-4">
                 <p class="text-rpg-subtext text-sm italic">YÃ¼kleniyor...</p>
            </div>
        </section>

        <section class="bg-rpg-card rounded-xl p-5 shadow-md mb-8 border border-rpg-border">
            <h3 class="text-xl font-semibold mb-4 text-rpg-accent border-b border-rpg-border pb-2">AylÄ±k Ä°statistikler</h3>
            <div id="chartContainer" class="mb-6">
                <canvas id="activityChart"></canvas>
            </div>
            <div class="overflow-x-auto">
                 <table class="w-full min-w-[400px] text-sm text-left text-rpg-subtext">
                    <thead class="text-xs text-rpg-text uppercase bg-gray-700">
                        <tr>
                            <th scope="col" class="px-6 py-3 rounded-tl-lg">Tarih</th>
                            <th scope="col" class="px-6 py-3">Fiziksel</th>
                            <th scope="col" class="px-6 py-3 rounded-tr-lg">Zihinsel</th>
                        </tr>
                    </thead>
                    <tbody id="log" class="[&>*:nth-child(odd)]:bg-rpg-card [&>*:nth-child(even)]:bg-gray-700">
                        <tr class="border-b border-rpg-border">
                            <td colspan="3" class="px-6 py-4 text-center">HenÃ¼z kayÄ±t yok.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section class="bg-rpg-card rounded-xl p-5 shadow-md border border-rpg-border mb-8">
             <h3 class="text-xl font-semibold mb-4 text-rpg-accent border-b border-rpg-border pb-2">Yeni GÃ¶rev Ekle</h3>
             <form id="addTaskForm" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-5 gap-4 items-end">
                 <div>
                     <label for="taskName" class="form-label">GÃ¶rev AdÄ±</label>
                     <input type="text" id="taskName" name="taskName" class="form-input" required placeholder="Ã–rn: Kitap Oku">
                 </div>
                 <div>
                     <label for="taskXp" class="form-label">XP DeÄŸeri</label>
                     <input type="number" id="taskXp" name="taskXp" class="form-input" required min="1" placeholder="Ã–rn: 15">
                 </div>
                 <div>
                     <label for="taskStat" class="form-label">Yetenek</label>
                     <select id="taskStat" name="taskStat" class="form-select" required>
                         <option value="">SeÃ§iniz...</option>
                     </select>
                 </div>
                 <div>
                     <label for="taskType" class="form-label">TÃ¼r</label>
                     <select id="taskType" name="taskType" class="form-select" required>
                         <option value="">SeÃ§iniz...</option>
                         <option value="fiziksel">Fiziksel</option>
                         <option value="zihinsel">Zihinsel</option>
                     </select>
                 </div>
                 <button type="submit" class="btn btn-primary h-10 md:mt-0 mt-4">
                     <i class="fas fa-plus mr-1"></i> Ekle
                 </button>
             </form>
        </section>

        <section class="bg-rpg-card rounded-xl p-5 shadow-md border border-rpg-border mb-8">
            <h3 class="text-xl font-semibold mb-4 text-rpg-accent border-b border-rpg-border pb-2">ApexAI GÃ¶rev Ã–nerici ğŸ¤–</h3>
            <div class="mb-4">
                <label for="geminiPrompt" class="form-label">ApexAI'den GÃ¶rev Ã–nerileri Al</label>
                <textarea id="geminiPrompt" class="form-input h-24 resize-y" placeholder="Ã–rn: Daha fazla odaklanmama yardÄ±mcÄ± olacak zihinsel gÃ¶revler Ã¶ner."></textarea>
            </div>
            <button id="suggestTasksButton" class="btn btn-primary w-full mb-4">
                <i class="fas fa-magic mr-1"></i> GÃ¶rev Ã–ner
            </button>
            <div id="geminiLoading" class="hidden text-center text-rpg-subtext">
                <i class="fas fa-spinner fa-spin text-2xl"></i> GÃ¶revler yÃ¼kleniyor...
            </div>
            <div id="suggestedTasksOutput" class="space-y-3">
                </div>
        </section>

        <section class="text-center">
            <button id="resetButton" class="btn btn-danger">
                <i class="fas fa-trash-alt mr-1"></i> TÃ¼m Verileri SÄ±fÄ±rla
            </button>
        </section>

    </main>

    <div id="confirmationModal" class="modal opacity-0 pointer-events-none" aria-labelledby="modal-title" role="role" aria-modal="true">
        <div class="modal-content transform scale-95 transition-transform duration-300 ease-out">
            <h3 class="text-lg font-semibold text-rpg-accent mb-4" id="modal-title">Emin misiniz?</h3>
            <p class="text-sm text-rpg-subtext mb-6" id="modal-message">Bu iÅŸlem geri alÄ±namaz. TÃ¼m ilerlemeniz ve gÃ¶revleriniz kalÄ±cÄ± olarak silinecektir.</p>
            <div class="flex justify-end space-x-3">
                <button id="modalCancelButton" class="btn btn-secondary">Ä°ptal</button>
                <button id="modalConfirmButton" class="btn btn-danger">Evet, SÄ±fÄ±rla</button>
            </div>
        </div>
    </div>

    <div id="welcomeModal" class="modal opacity-0 pointer-events-none" aria-hidden="true">
        <div class="modal-content transform scale-95 transition-transform duration-300 ease-out">
            <h3 class="text-lg font-semibold text-rpg-accent mb-4">Apex Fusion'e HoÅŸ Geldiniz, Maceraperest! ğŸ‘‹</h3>
            <p class="text-sm text-rpg-subtext mb-6">
                Kendinizi geliÅŸtirme yolculuÄŸunuzda bir Ã¼st seviyeye Ã§Ä±kmaya hazÄ±r mÄ±sÄ±nÄ±z? ğŸ”¥ Apex Fusion, gÃ¼nlÃ¼k rutinlerinizi heyecan verici bir RPG deneyimine dÃ¶nÃ¼ÅŸtÃ¼rerek hem fiziksel ğŸ’ª hem de zihinsel ğŸ¤” potansiyelinizi en Ã¼st dÃ¼zeye Ã§Ä±karmanÄ±z iÃ§in tasarlandÄ±.
                <br><br>
                UygulamamÄ±zda, belirlediÄŸiniz veya Ã¶nerilen gÃ¶revleri tamamlayarak deneyim puanlarÄ± (XP) âœ¨ kazanacak, seviye atlayacak â¬†ï¸ ve yeni yeteneklerin kilidini aÃ§acaksÄ±nÄ±z. Her gÃ¶rev, 'Strateji' ğŸ§ , 'Bilgi' ğŸ“š, 'YaratÄ±cÄ±lÄ±k' ğŸ¨, 'Hareket' ğŸƒâ€â™€ï¸ ve 'SaÄŸlÄ±k' â¤ï¸ gibi farklÄ± yetenek alanlarÄ±nÄ±zÄ± gÃ¼Ã§lendirecek.
                <br><br>
                Ä°lerlemenizi detaylÄ± istatistikler ğŸ“Š ve grafiklerle takip edin, gÃ¼nlÃ¼k tamamlama serileri ğŸ”¥ oluÅŸturarak motivasyonunuzu canlÄ± tutun ve kilometre taÅŸlarÄ±na ulaÅŸtÄ±kÃ§a Ã¶zel rozetler ğŸ… kazanÄ±n. Kendi kiÅŸisel geliÅŸim yol haritanÄ±zÄ± oluÅŸturmak iÃ§in gÃ¶revlerinizi Ã¶zelleÅŸtirin veya yenilerini ekleyin âœï¸.
                <br><br>
                Apex Fusion, sadece bir gÃ¶rev takip uygulamasÄ± deÄŸil, kendi en iyi versiyonunuza ulaÅŸmanÄ±z iÃ§in bir araÃ§tÄ±r. UnutmayÄ±n, her kÃ¼Ã§Ã¼k adÄ±m bÃ¼yÃ¼k bir deÄŸiÅŸimin baÅŸlangÄ±cÄ±dÄ±r. Bu macerada size eÅŸlik etmek iÃ§in buradayÄ±z! Diamond! ğŸ’
            </p>
            <div class="flex justify-end">
                <button id="closeWelcomeModalButton" class="btn btn-primary">BaÅŸlayÄ±n! â–¶ï¸</button>
            </div>
        </div>
    </div>

    <footer class="bg-rpg-card py-4 text-center text-rpg-subtext text-sm mt-8 border-t border-rpg-border">
        Â© 2025 Yusuf Eden tarafÄ±ndan yapÄ±lmÄ±ÅŸtÄ±r.
    </footer>


    <script>
        const LOCAL_STORAGE_KEYS = {
            xp: 'rpg_xp_v4',
            history: 'rpg_history_v4',
            tasks: 'rpg_tasks_v4',
            stats: 'rpg_stats_v4',
            customTasks: 'rpg_customTasks_v4',
            lastCompletionDate: 'rpg_lastCompletionDate_v4',
            streak: 'rpg_streak_v4',
            lastStatResetMonth: 'rpg_lastStatResetMonth_v4',
            hasSeenWelcome: 'rpg_hasSeenWelcome_v1',
            removedDefaultTasks: 'rpg_removedDefaultTasks_v1'
        };

        const BASE_XP_FOR_LEVEL_1 = 500;
        const BASE_LEVEL_INCREMENT = 1000;
        const ADDITIONAL_INCREMENT_PER_LEVEL = 500;

        function getTotalXPForLevel(level) {
            if (level < 1) return 0;
            if (level === 1) return BASE_XP_FOR_LEVEL_1;

            let totalXP = BASE_XP_FOR_LEVEL_1;
            let currentIncrement = BASE_LEVEL_INCREMENT;

            for (let i = 2; i <= level; i++) {
                totalXP += currentIncrement;
                currentIncrement += ADDITIONAL_INCREMENT_PER_LEVEL;
            }
            return totalXP;
        }


        const BADGES = [
            { xp: 500, icon: 'ğŸ¥ˆ', name: 'Yol HaritasÄ± Ã‡izer', rank: 'BaÅŸlangÄ±Ã§' },
            { xp: 1500, icon: 'ğŸ¥‡', name: 'Zihin Kalesinin MimarÄ±', rank: 'YÃ¼kseliÅŸ' },
            { xp: 3000, icon: 'ğŸ’', name: 'Potansiyel GeliÅŸtirici', rank: 'UstalÄ±k' },
            { xp: 5000, icon: 'ğŸ†', name: 'Strateji UstasÄ± AdayÄ±', rank: 'KahramanlÄ±k' },
            { xp: 7500, icon: 'ğŸŒŸ', name: 'Ä°Ã§sel Usta', rank: 'Efsanevi' },
            { xp: getTotalXPForLevel(6), icon: 'âœ¨', name: 'GerÃ§eklik SimyacÄ±sÄ±', rank: 'GerÃ§eklik' },
        ];

        const INITIAL_STATS = {
            Strateji: 0,
            Bilgi: 0,
            YaratÄ±cÄ±lÄ±k: 0,
            FarkÄ±ndalÄ±k: 0,
            Beceri: 0,
            Hareket: 0,
            SaÄŸlÄ±k: 0,
            Beden: 0
        };

        const DEFAULT_TASKS = [
          { id: 'u6', name: 'Dengeli Beslen / Yeterli Su Ä°Ã§', xp: 10, stat: 'SaÄŸlÄ±k', type: 'fiziksel' },
          { id: 'f9', name: 'Esneklik Egzersizi (Germe)', xp: 12, stat: 'Beden', type: 'fiziksel' },
          { id: 'u2', name: 'GÃ¼Ã§ ÃœÃ§geni Egzersizi (ÅÄ±nav, Squat, Plank)', xp: 14, stat: 'Beden', type: 'fiziksel' },
          { id: 'u5', name: 'GÃ¼nlÃ¼k KoÅŸu/YÃ¼rÃ¼yÃ¼ÅŸ Yap (20-30 dk)', xp: 14, stat: 'Hareket', type: 'fiziksel' },
          { id: 'u4', name: 'GÃ¼nlÃ¼k Yaz (Duygu/DÃ¼ÅŸÃ¼nce)', xp: 10, stat: 'FarkÄ±ndalÄ±k', type: 'zihinsel' },
          { id: 'u3', name: 'Kitap Oku / AraÅŸtÄ±rma Yap (15-20 dk)', xp: 12, stat: 'Bilgi', type: 'zihinsel' },
          { id: 'u7', name: 'Strateji Oyunu Oyna (SatranÃ§, Sudoku vb.)', xp: 13, stat: 'Strateji', type: 'zihinsel' },
          { id: 'u8', name: 'Zihin Haritalama Yap (Mind Mapping)', xp: 15, stat: 'YaratÄ±cÄ±lÄ±k', type: 'zihinsel' },
        ];

        const elements = {
            physicalTasksContainer: document.getElementById('physicalTasks'),
            mentalTasksContainer: document.getElementById('mentalTasks'),
            addTaskForm: document.getElementById('addTaskForm'),
            taskStatSelect: document.getElementById('taskStat'),
            doneCount: document.getElementById('doneCount'),
            level: document.getElementById('level'),
            xpCount: document.getElementById('xpCount'),
            xpBar: document.getElementById('xpBar'),
            xpNextLevel: document.getElementById('xpNextLevel'),
            streakCount: document.getElementById('streakCount'),
            badges: document.getElementById('badges'),
            statBars: document.getElementById('statBars'),
            logTbody: document.getElementById('log'),
            chartCanvas: document.getElementById('activityChart'),
            resetButton: document.getElementById('resetButton'),
            confirmationModal: document.getElementById('confirmationModal'),
            modalCancelButton: document.getElementById('modalCancelButton'),
            modalConfirmButton: document.getElementById('modalConfirmButton'),
            authStatus: document.getElementById('auth-status'),
            userEmail: document.getElementById('user-email'),
            authButton: document.getElementById('auth-button'),
            welcomeModal: document.getElementById('welcomeModal'),
            closeWelcomeModalButton: document.getElementById('closeWelcomeModalButton'),
            geminiPrompt: document.getElementById('geminiPrompt'),
            suggestTasksButton: document.getElementById('suggestTasksButton'),
            geminiLoading: document.getElementById('geminiLoading'),
            suggestedTasksOutput: document.getElementById('suggestedTasksOutput')
        };

        let state = {
            xp: 0,
            history: {},
            tasks: {},
            stats: { ...INITIAL_STATS },
            customTasks: [],
            lastCompletionDate: null,
            streak: 0,
            lastStatResetMonth: null,
            removedDefaultTaskIds: []
        };

        let activityChart;
        function initializeChart() {
             if (activityChart) activityChart.destroy();
             const ctx = elements.chartCanvas.getContext('2d');
             activityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Fiziksel GÃ¶rev',
                            data: [],
                            backgroundColor: tailwind.config.theme.extend.colors['rpg-physical'],
                            borderColor: tailwind.config.theme.extend.colors['rpg-accent'],
                            borderWidth: 1,
                            borderRadius: 5,
                        },
                        {
                            label: 'Zihinsel GÃ¶rev',
                            data: [],
                            backgroundColor: tailwind.config.theme.extend.colors['rpg-mental'],
                            borderColor: 'rgba(0, 206, 209, 1)',
                            borderWidth: 1,
                            borderRadius: 5,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: tailwind.config.theme.extend.colors['rpg-subtext'],
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: { color: tailwind.config.theme.extend.colors['rpg-border'] }
                        },
                        x: {
                            ticks: { color: tailwind.config.theme.extend.colors['rpg-subtext'] },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: tailwind.config.theme.extend.colors['rpg-text'],
                                boxWidth: 12,
                                padding: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: tailwind.config.theme.extend.colors['rpg-card'],
                            titleColor: tailwind.config.theme.extend.colors['rpg-accent'],
                            bodyColor: tailwind.config.theme.extend.colors['rpg-text'],
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) label += context.parsed.y + '%';
                                    return label;
                                }
                            }
                        }
                    }
                }
             });
        }

        const todayKey = () => new Date().toLocaleDateString('tr-TR');
        const todayIsoDate = () => new Date().toISOString().split('T')[0];

        const getCurrentMonthKey = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            return `${year}-${month}`;
        };

        function getTaskCountForStat(statKey) {
            const allTasks = getAllTasks();
            return allTasks.filter(task => task.stat === statKey).length;
        }

        function getTotalTasksByType(type) {
             const allTasks = getAllTasks();
             return allTasks.filter(task => task.type === type).length;
        }

        function getAllTasks() {
            const activeDefaultTasks = DEFAULT_TASKS.filter(task => !state.removedDefaultTaskIds.includes(task.id));
            return [...activeDefaultTasks, ...state.customTasks];
        }

        async function loadState(user) {
            const currentMonthKey = getCurrentMonthKey();

            if (user) {
                const userDocRef = db.collection('users').doc(user.uid);
                try {
                    const doc = await userDocRef.get();
                    if (doc.exists) {
                        state = doc.data();

                        if (!state.removedDefaultTaskIds) {
                            state.removedDefaultTaskIds = [];
                        }

                        if (state.lastStatResetMonth !== currentMonthKey) {
                            state.stats = { ...INITIAL_STATS };
                            state.lastStatResetMonth = currentMonthKey;
                            await saveState(user);
                            showNotification("Yeni Ay BaÅŸlangÄ±cÄ±!", "Bu ayki yetenek puanlarÄ±nÄ±z sÄ±fÄ±rlandÄ±.");
                        }

                         if (state.lastCompletionDate) {
                            const lastDate = new Date(state.lastCompletionDate);
                            const yesterday = new Date();
                            yesterday.setDate(yesterday.getDate() - 1);
                            lastDate.setHours(0,0,0,0);
                            yesterday.setHours(0,0,0,0);
                            if (lastDate < yesterday) {
                                state.streak = 0;
                                state.lastCompletionDate = null;
                                await saveState(user);
                            }
                        }

                    } else {
                        state = {
                            xp: 0,
                            history: {},
                            tasks: {},
                            stats: { ...INITIAL_STATS },
                            customTasks: [],
                            lastCompletionDate: null,
                            streak: 0,
                            lastStatResetMonth: currentMonthKey,
                            removedDefaultTaskIds: []
                        };
                         await saveState(user);
                         showNotification("HoÅŸ Geldiniz!", "Yeni bir profil oluÅŸturuldu.");
                    }
                } catch (error) {
                    console.error("Firebase veri yÃ¼kleme hatasÄ±:", error);
                    loadStateLocal();
                    showNotification("Hata!", "Firebase verileri yÃ¼klenemedi, yerel depolama kullanÄ±lÄ±yor.");
                }
            } else {
                loadStateLocal();
            }

            renderAll();
        }

        function loadStateLocal() {
            state.xp = parseInt(localStorage.getItem(LOCAL_STORAGE_KEYS.xp) || '0', 10);
            state.history = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEYS.history) || '{}');
            state.tasks = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEYS.tasks) || '{}');
            const savedStats = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEYS.stats) || '{}');
            state.stats = { ...INITIAL_STATS, ...savedStats };
            state.customTasks = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEYS.customTasks) || '[]');
            state.lastCompletionDate = localStorage.getItem(LOCAL_STORAGE_KEYS.lastCompletionDate);
            state.streak = parseInt(localStorage.getItem(LOCAL_STORAGE_KEYS.streak) || '0', 10);
            state.lastStatResetMonth = localStorage.getItem(LOCAL_STORAGE_KEYS.lastStatResetMonth);
            state.removedDefaultTaskIds = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEYS.removedDefaultTasks) || '[]');


            const currentMonthKey = getCurrentMonthKey();
            if (state.lastStatResetMonth !== currentMonthKey) {
                state.stats = { ...INITIAL_STATS };
                state.lastStatResetMonth = currentMonthKey;
                saveStateLocal();
                showNotification("Yeni Ay BaÅŸlangÄ±cÄ±!", "Bu ayki yerel yetenek puanlarÄ±nÄ±z sÄ±fÄ±rlandÄ±.");
            }

             if (state.lastCompletionDate) {
                const lastDate = new Date(state.lastCompletionDate);
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                lastDate.setHours(0,0,0,0);
                yesterday.setHours(0,0,0,0);
                if (lastDate < yesterday) {
                    state.streak = 0;
                    state.lastCompletionDate = null;
                    saveStateLocal();
                }
            }
        }


        async function saveState(user) {
            if (user) {
                const userDocRef = db.collection('users').doc(user.uid);
                try {
                    await userDocRef.set(state);
                } catch (error) {
                    console.error("Firebase veri kaydetme hatasÄ±:", error);
                    showNotification("Hata!", "Firebase verileri kaydedilemedi.");
                }
            } else {
                saveStateLocal();
            }
        }

        function saveStateLocal() {
            localStorage.setItem(LOCAL_STORAGE_KEYS.xp, state.xp.toString());
            localStorage.setItem(LOCAL_STORAGE_KEYS.history, JSON.stringify(state.history));
            localStorage.setItem(LOCAL_STORAGE_KEYS.tasks, JSON.stringify(state.tasks));
            localStorage.setItem(LOCAL_STORAGE_KEYS.stats, JSON.stringify(state.stats));
            localStorage.setItem(LOCAL_STORAGE_KEYS.customTasks, JSON.stringify(state.customTasks));
            if (state.lastCompletionDate) {
                localStorage.setItem(LOCAL_STORAGE_KEYS.lastCompletionDate, state.lastCompletionDate);
            } else {
                 localStorage.removeItem(LOCAL_STORAGE_KEYS.lastCompletionDate);
            }
            localStorage.setItem(LOCAL_STORAGE_KEYS.streak, state.streak.toString());
            if (state.lastStatResetMonth) {
                localStorage.setItem(LOCAL_STORAGE_KEYS.lastStatResetMonth, state.lastStatResetMonth);
            } else {
                 localStorage.removeItem(LOCAL_STORAGE_KEYS.lastStatResetMonth);
            }
            localStorage.setItem(LOCAL_STORAGE_KEYS.removedDefaultTasks, JSON.stringify(state.removedDefaultTaskIds));
        }


        function calculateLevelInfo(currentXP) {
            let currentLevel = 1;
            let xpForCurrentLevel = 0;
            let xpForNextLevel = getTotalXPForLevel(1);

            while (currentXP >= xpForNextLevel && currentLevel < 100) {
                currentLevel++;
                xpForCurrentLevel = xpForNextLevel;
                xpForNextLevel = getTotalXPForLevel(currentLevel);
            }

            const xpProgressInLevel = currentXP - xpForCurrentLevel;
            const xpNeededForNext = xpForNextLevel - xpForCurrentLevel;
            const progressPercentage = (xpNeededForNext > 0) ? (xpProgressInLevel / xpNeededForNext) * 100 : 100;


            return {
                level: currentLevel,
                xpForNext: xpForNextLevel,
                progress: xpProgressInLevel,
                neededForNext: xpNeededForNext,
                percentage: Math.min(100, progressPercentage)
            };
        }

        function renderTasks() {
             elements.physicalTasksContainer.innerHTML = '';
             elements.mentalTasksContainer.innerHTML = '';
             const allTasks = getAllTasks();

             if (allTasks.length === 0) {
                 elements.physicalTasksContainer.innerHTML = '<p class="text-rpg-subtext text-sm italic">HenÃ¼z fiziksel gÃ¶rev yok.</p>';
                 elements.mentalTasksContainer.innerHTML = '<p class="text-rpg-subtext text-sm italic">HenÃ¼z zihinsel gÃ¶rev yok.</p>';
                 return;
             }

             allTasks.forEach(task => {
                 const taskElement = document.createElement('div');
                 taskElement.className = 'task flex items-center p-3 rounded-lg transition duration-200 ease-in-out hover:bg-gray-700';
                 taskElement.dataset.xp = task.xp;
                 taskElement.dataset.stat = task.stat;
                 taskElement.dataset.type = task.type;
                 taskElement.dataset.id = task.id;
                 const isDefault = DEFAULT_TASKS.some(dt => dt.id === task.id);
                 taskElement.dataset.isDefault = isDefault;


                 const isChecked = state.tasks[task.id] || false;
                 const labelClass = isChecked ? 'flex-1 cursor-pointer text-rpg-text line-through text-rpg-subtext' : 'flex-1 cursor-pointer text-rpg-text';

                 const statDisplay = task.stat ? task.stat.substring(0,3) + '.' : '';

                 taskElement.innerHTML = `
                     <input type="checkbox" id="${task.id}" class="task-checkbox form-checkbox h-5 w-5 text-rpg-accent bg-gray-600 border-gray-500 rounded focus:ring-rpg-accent mr-3 cursor-pointer" ${isChecked ? 'checked' : ''}>
                     <label for="${task.id}" class="${labelClass}">${task.name}</label>
                     <span class="text-xs text-rpg-subtext ml-2">(+${task.xp} XP, +1 ${statDisplay})</span>
                     <button class="delete-task-btn text-red-500 hover:text-red-400 text-xs ml-2 p-1" title="GÃ¶revi Sil"><i class="fas fa-times"></i></button>
                 `;

                 const checkbox = taskElement.querySelector('.task-checkbox');
                 checkbox.addEventListener('change', handleTaskChange);

                 const deleteButton = taskElement.querySelector('.delete-task-btn');
                 deleteButton.addEventListener('click', () => handleDeleteTask(task.id));


                 if (task.type === 'fiziksel') {
                     elements.physicalTasksContainer.appendChild(taskElement);
                 } else if (task.type === 'zihinsel') {
                     elements.mentalTasksContainer.appendChild(taskElement);
                 }
             });

             if (elements.physicalTasksContainer.children.length === 0) {
                 elements.physicalTasksContainer.innerHTML = '<p class="text-rpg-subtext text-sm italic">HenÃ¼z fiziksel gÃ¶rev yok.</p>';
             }
             if (elements.mentalTasksContainer.children.length === 0) {
                 elements.mentalTasksContainer.innerHTML = '<p class="text-rpg-subtext text-sm italic">HenÃ¼z zihinsel gÃ¶rev yok.</p>';
             }
        }


        function renderSummary() {
            const allTasks = getAllTasks();
            const totalTasks = allTasks.length;
            const completedTasks = Object.values(state.tasks).filter(Boolean).length;
            elements.doneCount.textContent = `${completedTasks} / ${totalTasks}`;

            const levelInfo = calculateLevelInfo(state.xp);
            elements.level.textContent = levelInfo.level;
            elements.xpCount.textContent = state.xp;
            elements.xpBar.style.width = `${levelInfo.percentage}%`;
            elements.xpNextLevel.textContent = levelInfo.neededForNext <= 0 ? "Maksimum Seviye!" : `Sonraki seviye iÃ§in: ${levelInfo.neededForNext} XP`;


            elements.streakCount.innerHTML = `<i class="fas fa-fire ${state.streak > 0 ? 'text-rpg-streak' : 'text-rpg-subtext'}"></i> ${state.streak}`;
        }

        function renderBadges() {
            elements.badges.innerHTML = '';
            let earnedBadges = 0;
            BADGES.forEach(badge => {
                if (state.xp >= badge.xp) {
                    const badgeSpan = document.createElement('span');
                    badgeSpan.className = 'text-3xl tooltip';
                    badgeSpan.textContent = badge.icon;
                    badgeSpan.dataset.tooltip = `${badge.rank}: ${badge.name} (${badge.xp} XP)`;
                    elements.badges.appendChild(badgeSpan);
                    earnedBadges++;
                }
            });
            if (earnedBadges === 0) {
                elements.badges.innerHTML = '<span class="text-rpg-subtext text-sm">HenÃ¼z rozet yok</span>';
            }
        }

        function renderStats() {
            elements.statBars.innerHTML = '';
            const allTasks = getAllTasks();

            const taskCountPerStat = {};
            for (const statKey in INITIAL_STATS) {
                taskCountPerStat[statKey] = allTasks.filter(task => task.stat === statKey).length;
            }

            const sortedStats = Object.entries(state.stats).sort((a, b) => a[0].localeCompare(b[0]));

            for (const [key, value] of sortedStats) {
                const numberOfTasks = taskCountPerStat[key] || 0;
                const monthlyMaxCompletions = numberOfTasks * 30;

                const percentage = monthlyMaxCompletions > 0 ? (value / monthlyMaxCompletions) * 100 : 0;

                const statDiv = document.createElement('div');
                statDiv.className = 'stat-bar-container';
                statDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium text-rpg-subtext">${key}</span>
                        <span class="text-sm font-medium text-rpg-text">${percentage.toFixed(1)}%</span> </div>
                    <div class="w-full bg-rpg-progress-bg rounded-full h-2.5">
                        <div class="bg-rpg-accent h-2.5 rounded-full transition-all duration-500 ease-out" style="width: ${percentage}%"></div>
                    </div>
                `;
                elements.statBars.appendChild(statDiv);
            }
        }

        function renderHistory() {
             elements.logTbody.innerHTML = '';
             const historyEntries = Object.entries(state.history);
             historyEntries.sort(([, a], [, b]) => new Date(b.date || 0) - new Date(a.date || 0));

             const chartLabels = [];
             const chartDataPhysical = [];
             const chartDataMental = [];

             const totalPhysicalTasks = getTotalTasksByType('fiziksel');
             const totalMentalTasks = getTotalTasksByType('zihinsel');


             if (historyEntries.length === 0) {
                 elements.logTbody.innerHTML = `<tr class="border-b border-rpg-border"><td colspan="3" class="px-6 py-4 text-center text-rpg-subtext">HenÃ¼z kayÄ±t yok.</td></tr>`;
             }
             else {
                 const thirtyDaysAgo = new Date();
                 thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                 thirtyDaysAgo.setHours(0,0,0,0);

                 historyEntries.forEach(([dateStr, data]) => {
                     const dateParts = dateStr.split('.');
                     const entryDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                     entryDate.setHours(0,0,0,0);

                     const row = document.createElement('tr');
                     row.className = 'border-b border-rpg-border';
                     row.innerHTML = `
                         <td class="px-6 py-4 font-medium text-rpg-text whitespace-nowrap">${dateStr}</td>
                         <td class="px-6 py-4">${data.fiziksel || 0}</td>
                         <td class="px-6 py-4">${data.zihinsel || 0}</td>
                     `;
                     elements.logTbody.appendChild(row);

                     if (entryDate >= thirtyDaysAgo) {
                         chartLabels.push(dateStr);
                         const physicalPercentage = totalPhysicalTasks > 0 ? (data.fiziksel / totalPhysicalTasks) * 100 : 0;
                         const mentalPercentage = totalMentalTasks > 0 ? (data.zihinsel / totalMentalTasks) * 100 : 0;

                         chartDataPhysical.push(parseFloat(physicalPercentage.toFixed(1)));
                         chartDataMental.push(parseFloat(mentalPercentage.toFixed(1)));
                     }
                 });

                 chartLabels.reverse();
                 chartDataPhysical.reverse();
                 chartDataMental.reverse();

                 activityChart.data.labels = chartLabels;
                 activityChart.data.datasets[0].data = chartDataPhysical;
                 activityChart.data.datasets[1].data = chartDataMental;
                 activityChart.update();
             }
        }


        function renderAll() {
            renderTasks();
            renderSummary();
            renderBadges();
            renderStats();
            renderHistory();
        }

        async function handleTaskChange(event) {
            const checkbox = event.target;
            const taskElement = checkbox.closest('.task');
            const taskId = checkbox.id;
            const taskData = getAllTasks().find(t => t.id === taskId);

            if (!taskData) {
                return;
            }

            const xpValue = taskData.xp;
            const statKey = taskData.stat;
            const isChecked = checkbox.checked;

            state.tasks[taskId] = isChecked;

            const xpChange = isChecked ? xpValue : -xpValue;
            const statChange = isChecked ? 1 : -1;

            const previousLevel = calculateLevelInfo(state.xp).level;

            state.xp += xpChange;
            if (state.xp < 0) state.xp = 0;

            if (state.stats[statKey] !== undefined) {
                state.stats[statKey] += statChange;
                if (state.stats[statKey] < 0) state.stats[statKey] = 0;
            }

            const today = todayKey();
            const todayISO = todayIsoDate();

            if (!state.history[today]) {
                state.history[today] = {
                    xp: 0,
                    fiziksel: 0,
                    zihinsel: 0,
                    date: new Date().toISOString()
                };
            }

            if (isChecked) {
                if (taskData.type === 'fiziksel') state.history[today].fiziksel++;
                else if (taskData.type === 'zihinsel') state.history[today].zihinsel++;
            } else {
                state.history[today].fiziksel = Math.max(0, state.history[today].fiziksel - (taskData.type === 'fiziksel' ? 1 : 0));
                state.history[today].zihinsel = Math.max(0, state.history[today].zihinsel - (taskData.type === 'zihinsel' ? 1 : 0));
            }

            if (isChecked) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayISO = yesterday.toISOString().split('T')[0];

                if (state.lastCompletionDate === todayISO) {
                } else if (state.lastCompletionDate === yesterdayISO) {
                    state.streak++;
                    state.lastCompletionDate = todayISO;
                } else {
                    state.streak = 1;
                    state.lastCompletionDate = todayISO;
                }
            }

            await saveState(auth.currentUser);

            renderAll();

            const currentLevel = calculateLevelInfo(state.xp).level;
            if (currentLevel > previousLevel) {
                showNotification(`Tebrikler! Seviye ${currentLevel}'e ulaÅŸtÄ±n! ğŸ‰`);
            } else {
                const statDisplay = taskData.stat ? taskData.stat.substring(0,3) + '.' : '';
                showNotification(`GÃ¶rev ${isChecked ? 'tamamlandÄ±' : 'iptal edildi'}: ${taskData.name}`, `${xpChange > 0 ? '+' : ''}${xpChange} XP${statKey ? ', ' + (isChecked ? '+' : '-') + '1 ' + statDisplay : ''}`);
            }
        }


        async function handleAddTask(event) {
            event.preventDefault();
            const form = event.target;
            const name = form.taskName.value.trim();
            const xp = parseInt(form.taskXp.value, 10);
            const stat = form.taskStat.value;
            const type = form.taskType.value;

            if (!name || isNaN(xp) || xp <= 0 || !stat || !type) {
                showNotification("Hata", "LÃ¼tfen tÃ¼m alanlarÄ± doÄŸru ÅŸekilde doldurun.");
                return;
            }

            const newTask = { id: `custom_${Date.now()}`, name: name, xp: xp, stat: stat, type: type };

            state.customTasks.push(newTask);

            await saveState(auth.currentUser);

            renderAll();

            form.reset();

            const statDisplay = stat ? stat.substring(0,3) + '.' : '';
            showNotification("Yeni GÃ¶rev Eklendi!", `${name} (+${xp} XP, +1 ${statDisplay})`);
        }

        async function handleDeleteTask(taskId) {
             const task = getAllTasks().find(t => t.id === taskId);
             if (!task) return;

             const isDefault = DEFAULT_TASKS.some(dt => dt.id === taskId);
             const taskName = task.name;

             showConfirmationModal(
                 isDefault ? "VarsayÄ±lan GÃ¶revi Sil" : "Ã–zel GÃ¶revi Sil",
                 `"${taskName}" gÃ¶revini silmek istediÄŸinizden emin misiniz? ${isDefault ? "Bu varsayÄ±lan bir gÃ¶revdir ve silindikten sonra tekrar eklemek iÃ§in verileri sÄ±fÄ±rlamanÄ±z gerekebilir." : ""}`,
                 async () => {
                     if (isDefault) {
                         if (!state.removedDefaultTaskIds.includes(taskId)) {
                             state.removedDefaultTaskIds.push(taskId);
                         }
                     } else {
                         state.customTasks = state.customTasks.filter(t => t.id !== taskId);
                     }

                     delete state.tasks[taskId];

                     await saveState(auth.currentUser);
                     renderAll();
                     showNotification("GÃ¶rev Silindi.", `"${taskName}" gÃ¶revi kaldÄ±rÄ±ldÄ±.`);
                 }
             );
        }


        async function handleResetRequest() {
             showConfirmationModal(
                 "TÃ¼m Verileri SÄ±fÄ±rla",
                 "Emin misin? TÃ¼m ilerlemen ve gÃ¶revlerin silinecek! Bu iÅŸlem geri alÄ±namaz.",
                 async () => {
                     if (auth.currentUser) {
                         try {
                             await db.collection('users').doc(auth.currentUser.uid).delete();
                         } catch (error) {
                             console.error("Firebase veri silme hatasÄ±:", error);
                             showNotification("Hata!", "Firebase verileri silinemedi.");
                         }
                     }

                     localStorage.removeItem(LOCAL_STORAGE_KEYS.xp);
                     localStorage.removeItem(LOCAL_STORAGE_KEYS.history);
                     localStorage.removeItem(LOCAL_STORAGE_KEYS.tasks);
                     localStorage.removeItem(LOCAL_STORAGE_KEYS.stats);
                     localStorage.removeItem(LOCAL_STORAGE_KEYS.customTasks);
                     localStorage.removeItem(LOCAL_STORAGE_KEYS.lastCompletionDate);
                     localStorage.removeItem(LOCAL_STORAGE_KEYS.streak);
                     localStorage.removeItem(LOCAL_STORAGE_KEYS.lastStatResetMonth);
                     localStorage.removeItem(LOCAL_STORAGE_KEYS.hasSeenWelcome);
                     localStorage.removeItem(LOCAL_STORAGE_KEYS.removedDefaultTasks);

                     location.reload();
                 }
             );
        }

        let currentConfirmCallback = null;
        function showConfirmationModal(title, message, onConfirm) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            currentConfirmCallback = onConfirm;
            elements.confirmationModal.classList.remove('opacity-0', 'pointer-events-none');
            elements.confirmationModal.querySelector('.modal-content').classList.remove('scale-95');
            elements.confirmationModal.querySelector('.modal-content').classList.add('scale-100');
        }
        function hideConfirmationModal() {
            elements.confirmationModal.querySelector('.modal-content').classList.remove('scale-100');
            elements.confirmationModal.querySelector('.modal-content').classList.add('scale-95');
            elements.confirmationModal.classList.add('opacity-0');
            setTimeout(() => {
                elements.confirmationModal.classList.add('pointer-events-none');
                currentConfirmCallback = null;
            }, 300);
        }

        function showWelcomeModal() {
             elements.welcomeModal.classList.remove('opacity-0', 'pointer-events-none');
             elements.welcomeModal.querySelector('.modal-content').classList.remove('scale-95');
             elements.welcomeModal.querySelector('.modal-content').classList.add('scale-100');
        }

        function hideWelcomeModal() {
             elements.welcomeModal.querySelector('.modal-content').classList.remove('scale-100');
             elements.welcomeModal.querySelector('.modal-content').classList.add('scale-95');
             elements.welcomeModal.classList.add('opacity-0');
             setTimeout(() => {
                 elements.welcomeModal.classList.add('pointer-events-none');
             }, 300);
        }


        function showNotification(title, body = '') {
             if (!('Notification' in window)) {
                 return;
             }

             if (Notification.permission === 'granted') {
                 new Notification(title, { body: body, icon: './favicon.ico' });
             }
             else if (Notification.permission !== 'denied') {
                 Notification.requestPermission().then(permission => {
                     if (permission === 'granted') {
                         new Notification(title, { body: body, icon: './favicon.ico' });
                     }
                 });
             }
        }

        function populateStatOptions() {
            elements.taskStatSelect.innerHTML = '<option value="">SeÃ§iniz...</option>';
            for (const statKey in INITIAL_STATS) {
                const option = document.createElement('option');
                option.value = statKey;
                option.textContent = statKey;
                elements.taskStatSelect.appendChild(option);
            }
        }

        async function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                await auth.signInWithPopup(provider);
            } catch (error) {
                console.error("Google GiriÅŸ HatasÄ±:", error);
                showNotification("GiriÅŸ HatasÄ±", error.message);
            }
        }

        async function signOut() {
            try {
                await auth.signOut();
            } catch (error) {
                console.error("Ã‡Ä±kÄ±ÅŸ HatasÄ±:", error);
                showNotification("Ã‡Ä±kÄ±ÅŸ HatasÄ±", error.message);
            }
        }

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                elements.userEmail.textContent = user.email;
                elements.authButton.textContent = 'Ã‡Ä±kÄ±ÅŸ Yap';
                elements.authButton.removeEventListener('click', signInWithGoogle);
                elements.authButton.addEventListener('click', signOut);
                await loadState(user);
            } else {
                elements.userEmail.textContent = 'Misafir';
                elements.authButton.textContent = 'Google ile GiriÅŸ Yap';
                elements.authButton.removeEventListener('click', signOut);
                elements.authButton.addEventListener('click', signInWithGoogle);
                await loadState(null);

                const hasSeenWelcome = localStorage.getItem(LOCAL_STORAGE_KEYS.hasSeenWelcome);
                if (!hasSeenWelcome) {
                    setTimeout(() => {
                         showWelcomeModal();
                    }, 500);
                }
            }
        });

        async function callGeminiApi(prompt) {
            elements.geminiLoading.classList.remove('hidden');
            elements.suggestedTasksOutput.innerHTML = '';

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            const statEnumValues = Object.keys(INITIAL_STATS);

            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "name": { "type": "STRING" },
                                "xp": { "type": "NUMBER" },
                                "stat": { "type": "STRING", "enum": statEnumValues },
                                "type": { "type": "STRING", "enum": ["fiziksel", "zihinsel"] }
                            },
                            "required": ["name", "xp", "stat", "type"]
                        }
                    }
                }
            };

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const json = result.candidates[0].content.parts[0].text;
                    const parsedJson = JSON.parse(json);
                    displaySuggestedTasks(parsedJson);
                } else {
                    showNotification("Gemini HatasÄ±", "GÃ¶rev Ã¶nerileri alÄ±namadÄ±. LÃ¼tfen tekrar deneyin.");
                    console.error("Gemini API'den beklenen yanÄ±t alÄ±namadÄ±:", result);
                }
            } catch (error) {
                showNotification("AÄŸ HatasÄ±", "Gemini API'ye baÄŸlanÄ±rken bir sorun oluÅŸtu.");
                console.error("Gemini API Ã§aÄŸrÄ±sÄ± hatasÄ±:", error);
            } finally {
                elements.geminiLoading.classList.add('hidden');
            }
        }

        function displaySuggestedTasks(tasks) {
            elements.suggestedTasksOutput.innerHTML = '';
            if (tasks.length === 0) {
                elements.suggestedTasksOutput.innerHTML = '<p class="text-rpg-subtext text-sm italic">Ã–nerilen gÃ¶rev bulunamadÄ±.</p>';
                return;
            }

            tasks.forEach(task => {
                const taskElement = document.createElement('div');
                taskElement.className = 'flex items-center p-3 rounded-lg bg-gray-800 border border-rpg-border mb-2';
                const statDisplay = task.stat ? task.stat.substring(0,3) + '.' : '';
                taskElement.innerHTML = `
                    <div class="flex-1">
                        <p class="text-rpg-text font-medium">${task.name}</p>
                        <p class="text-xs text-rpg-subtext">+${task.xp} XP, +1 ${statDisplay} (${task.type === 'fiziksel' ? 'Fiziksel' : 'Zihinsel'})</p>
                    </div>
                    <button class="btn btn-primary btn-sm ml-4 add-suggested-task-btn"
                            data-name="${task.name}"
                            data-xp="${task.xp}"
                            data-stat="${task.stat}"
                            data-type="${task.type}">
                        Ekle
                    </button>
                `;
                elements.suggestedTasksOutput.appendChild(taskElement);
            });

            document.querySelectorAll('.add-suggested-task-btn').forEach(button => {
                button.addEventListener('click', addSuggestedTaskToRoutine);
            });
        }

        async function addSuggestedTaskToRoutine(event) {
            const button = event.target;
            const name = button.dataset.name;
            const xp = parseInt(button.dataset.xp, 10);
            const stat = button.dataset.stat;
            const type = button.dataset.type;

            const newTask = { id: `custom_${Date.now()}`, name: name, xp: xp, stat: stat, type: type };
            state.customTasks.push(newTask);
            await saveState(auth.currentUser);
            renderAll();
            showNotification("GÃ¶rev Eklendi!", `${name} rutininize eklendi.`);
            button.disabled = true;
            button.textContent = 'Eklendi';
            button.classList.remove('btn-primary');
            button.classList.add('btn-secondary');
        }


        function initializeApp() {
            if ('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                 Notification.requestPermission();
            }

            initializeChart();
            populateStatOptions();

            elements.addTaskForm.addEventListener('submit', handleAddTask);
            elements.resetButton.addEventListener('click', handleResetRequest);
            elements.modalCancelButton.addEventListener('click', hideConfirmationModal);
            elements.modalConfirmButton.addEventListener('click', () => {
                if (typeof currentConfirmCallback === 'function') {
                    currentConfirmCallback();
                }
                hideConfirmationModal();
            });

            elements.closeWelcomeModalButton.addEventListener('click', () => {
                hideWelcomeModal();
                localStorage.setItem(LOCAL_STORAGE_KEYS.hasSeenWelcome, 'true');
            });

            elements.suggestTasksButton.addEventListener('click', () => {
                const prompt = elements.geminiPrompt.value.trim();
                if (prompt) {
                    callGeminiApi(prompt);
                } else {
                    showNotification("UyarÄ±", "LÃ¼tfen bir gÃ¶rev Ã¶nerisi iÃ§in metin girin.");
                }
            });

        }

        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>

</body>
</html>
